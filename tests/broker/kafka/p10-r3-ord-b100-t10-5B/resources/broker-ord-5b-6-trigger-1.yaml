
---
apiVersion: eventing.knative.dev/v1
kind: Trigger
metadata:
  name: broker-ord-5b-6-trigger-1
  annotations:
    kafka.eventing.knative.dev/delivery.order: ordered
spec:
  broker: broker-ord-5b-6
  subscriber:
    ref:
      apiVersion: v1
      kind: Service
      name: broker-ord-5b-6-trigger-1
---
apiVersion: v1
kind: Service
metadata:
  name: broker-ord-5b-6-trigger-1
spec:
  type: ClusterIP
  selector:
    app: broker-ord-5b-6-trigger-1
  ports:
    - port: 80
      protocol: TCP
      targetPort: receiver
      name: http
    - port: 9090
      protocol: TCP
      targetPort: http-metrics
      name: http-metrics

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-sacura
data:
  sacura.yaml: |
    sender:
      disabled: true
    receiver:
      port: 8080
      timeout: 5m
      maxDuplicatesPercentage: 1
    duration: 10m
    timeout: 1m

---

apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: broker-ord-5b-6-trigger-1
  labels:
    app: broker-ord-5b-6-trigger-1
spec:
  endpoints:
    - path: /metrics
      port: http-metrics
  selector:
    matchLabels:
      app: broker-ord-5b-6-trigger-1
---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: broker-ord-5b-6-trigger-1
  labels:
    app: broker-ord-5b-6-trigger-1
spec:
  selector:
    matchLabels:
      app: broker-ord-5b-6-trigger-1
  template:
    metadata:
      labels:
        app: broker-ord-5b-6-trigger-1
    spec:
      containers:
        - name: receiver
          image: ghcr.io/pierdipi/sacura/sacura-7befbbbc92911c6727467cfbf23af88f
          args:
            - "--config"
            - "/etc/sacura/sacura.yaml"
          imagePullPolicy: Always
          resources:
            limits:
              memory: "500Mi"
              cpu: "1"
            requests:
              memory: "300Mi"
              cpu: "500m"
          volumeMounts:
          - mountPath: /etc/sacura
            name: config
          ports:
            - containerPort: 8080
              protocol: TCP
              name: receiver
            - containerPort: 9090
              protocol: TCP
              name: http-metrics
          env:
            - name: OTEL_RESOURCE_ATTRIBUTES
              value: "trigger=broker-ord-5b-6-trigger-1"
            - name: OTEL_SERVICE_NAME
              value: "sacura"
      volumes:
      - name: config
        configMap:
          name: config-sacura
 
